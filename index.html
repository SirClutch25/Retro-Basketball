<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Retro College Hoops — NBA Jam Style</title>
<style>
  body{background:#07120a;color:#fff;font-family:monospace;text-align:center}
  canvas{background:#083;display:block;margin:12px auto;border:6px solid #000;image-rendering:pixelated}
  #ui{max-width:980px;margin:0 auto}
  #controls button{margin:6px;padding:8px 12px;background:#111;color:#fff;border:1px solid #666}
  #plays{display:flex;gap:6px;justify-content:center;margin:8px}
  #info,#bracket,#stats{margin:8px}
  #playOverlay{position:fixed;left:50%;top:60%;transform:translate(-50%,-50%);background:#111;border:2px solid #fff;padding:10px;display:none}
</style>
</head>
<body>
  <div id="ui">
    <h1>Retro College Hoops — NBA Jam Style</h1>
    <p>Arrow keys to move, SPACE to shoot, P to pass. Playcalling 5-on-5 action!</p>
    <canvas id="game" width="420" height="560"></canvas>
    <div id="info"></div>
    <div id="controls">
      <button id="enterPlayMode">Enter Play Mode</button>
      <button id="subButton">Substitute</button>
      <button id="saveBtn">Save</button>
      <button id="loadBtn">Load</button>
    </div>
    <div id="plays"></div>
    <div id="bracket"></div>
    <div id="stats"></div>
  </div>

  <div id="playOverlay">
    <div><strong>Select a Play</strong></div>
    <div id="playOptions"></div>
    <div style="margin-top:8px"><button id="callPlay">Call Play</button> <button id="cancelPlay">Cancel</button></div>
  </div>

<script>
// === Utilities ===
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min}

// === Sprite system ===
function drawSprite(x,y,team,action,frame){
  ctx.save(); ctx.translate(x,y); ctx.imageSmoothingEnabled=false;
  const bodyColor = team==='home' ? '#FFD37F' : '#7FB3FF';
  const shortsColor = team==='home' ? '#663300' : '#003366';
  const skin = '#F2C99D';

  let armAngle=0, legOffset=0, torsoLean=0, headTilt=0;
  if(action==='run'){ armAngle=Math.sin(frame/4)*0.6; legOffset=Math.sin(frame/3)*4; torsoLean=Math.sin(frame/6)*2; }
  else if(action==='dribble'){ armAngle=Math.sin(frame/6)*0.4; legOffset=Math.sin(frame/8)*2; }
  else if(action==='shoot'){ armAngle=-1.2-(frame/6); headTilt=-0.2; }
  else if(action==='dunk'){ armAngle=-1.8-(frame/4); legOffset=-6; torsoLean=-6; }
  else{ armAngle=Math.sin(frame/12)*0.2; legOffset=0; }

  ctx.fillStyle=shortsColor;
  ctx.fillRect(-6,6+legOffset,5,12); ctx.fillRect(1,6-legOffset,5,12);
  ctx.fillStyle='#111';
  ctx.fillRect(-7,18+legOffset,7,4); ctx.fillRect(1,18-legOffset,7,4);
  ctx.fillStyle=bodyColor;
  ctx.fillRect(-10+torsoLean/3,-8,20,20);

  ctx.fillStyle='#000'; ctx.font='bold 8px monospace'; ctx.textAlign='center'; ctx.fillText('8',0,2);

  ctx.beginPath(); ctx.fillStyle=skin; ctx.arc(0,-14+headTilt*4,6,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#000'; ctx.fillRect(-2,-16,2,2); ctx.fillRect(2,-16,2,2);

  ctx.strokeStyle=skin; ctx.lineWidth=4; ctx.beginPath();
  ctx.moveTo(-10,-4); ctx.lineTo(-10-Math.cos(armAngle)*14,-4-Math.sin(armAngle)*8); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(10,-4); ctx.lineTo(10+Math.cos(armAngle)*14,-4-Math.sin(armAngle)*8); ctx.stroke();

  if(['dribble','dribble_hold','shoot','dunk'].includes(action)){
    ctx.fillStyle='#ffb400';
    ctx.beginPath(); ctx.arc(12,-4-Math.sin(frame/3)*6,5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#000'; ctx.lineWidth=1; ctx.stroke();
  }

  ctx.restore();
}

// === Player class ===
class Player{
  constructor(id,x,y,team,control=false){
    this.id=id;this.x=x;this.y=y;this.team=team;this.control=control;this.hasBall=false;
    this.action='idle';this.frame=0;this.points=0;this.shots=0;this.made=0;this.assists=0;
  }
  step(){ this.frame++; if(this.frame>10000)this.frame=0; }
  draw(){ drawSprite(this.x,this.y,this.team,this.action,this.frame); }
}

// === Court & Teams ===
const court={w:420,h:560};
let homeTeam=[], awayTeam=[];
function createTeams(){
  homeTeam = [
    new Player('H1',110,450,'home',true),
    new Player('H2',170,470,'home'),
    new Player('H3',230,470,'home'),
    new Player('H4',290,470,'home'),
    new Player('H5',350,470,'home')
  ];
  awayTeam = [
    new Player('A1',110,100,'away'),
    new Player('A2',170,120,'away'),
    new Player('A3',230,120,'away'),
    new Player('A4',290,120,'away'),
    new Player('A5',350,120,'away')
  ];
  homeTeam[0].hasBall=true;
}
createTeams();
let ball={x:homeTeam[0].x+12,y:homeTeam[0].y-6,moving:false,dx:0,dy:0,owner:homeTeam[0]};

// === Season & Playbook ===
let season={week:1,team:{name:'College A',rating:70,roster:[],record:{wins:0,losses:0}},opponents:[],bracket:[]};
function generateOpponents(){ season.opponents = Array.from({length:10},(_,i)=>({name:'Team '+(i+1),rating:40+rand(0,40)})); }
generateOpponents();
const playbook=[{id:'iso',name:'Isolation'},{id:'pickroll',name:'Pick & Roll'},{id:'post',name:'Post Up'},{id:'quick',name:'Quick Shot'},{id:'motion',name:'Motion'}];

// === UI ===
const playsDiv=document.getElementById('plays'), playOverlay=document.getElementById('playOverlay'), playOptions=document.getElementById('playOptions');
let selectedPlay=null;
function showPlayOverlay(){
  playOptions.innerHTML='';
  playbook.forEach(p=>{
    const btn=document.createElement('button');
    btn.textContent=p.name;
    btn.onclick=()=>{ selectedPlay=p; Array.from(playOptions.querySelectorAll('button')).forEach(b=>b.style.outline=''); btn.style.outline='2px solid #fff'; };
    playOptions.appendChild(btn);
  });
  playOverlay.style.display='block';
}
function hidePlayOverlay(){ playOverlay.style.display='none'; selectedPlay=null; }
function refreshPlaysUI(){ playsDiv.innerHTML='Play Mode: Call a play to simulate a set-piece.'; }
refreshPlaysUI();

// === Score/Controls ===
let disableControl=false, possession='home', homeScore=0, awayScore=0;

// Evaluate plays
function evaluatePlay(play){
  const teamRating=season.team.rating; let base=teamRating + rand(-10,10);
  let success=0.5;
  switch(play.id){
    case 'iso': success=0.46+(base-60)/200; break;
    case 'pickroll': success=0.56+(base-60)/200; break;
    case 'post': success=0.62+(base-60)/200; break;
    case 'quick': success=0.38+(base-60)/200; break;
    case 'motion': success=0.5+(base-60)/200; break;
  }
  const defAdj = season.opponents[Math.max(0,season.week-1)]?.rating-60 || 0;
  success -= defAdj/200;
  success=Math.max(0.12,Math.min(0.9,success));
  const made=Math.random()<success;
  let pts=2; if(['iso','quick','motion'].includes(play.id)&&Math.random()<0.18) pts=3;
  return {made,pts};
}

// Opponent possession
function opponentPossession(){
  const oppPlay = playbook[rand(0,playbook.length-1)];
  const oppRating = season.opponents[Math.max(0,season.week-1)]?.rating || 55;
  let succ=0.45+(oppRating-60)/200+(rand(-10,10)/100);
  succ=Math.max(0.1,Math.min(0.85,succ));
  const made=Math.random()<succ; const pts = Math.random()<0.18?3:2;
  if(made) awayScore+=pts; showMessage(`Opponent scored ${pts}`);
  possession='home';
  homeTeam.forEach((p,i)=>{ p.hasBall=i===0; }); ball.owner=homeTeam[0]; updateUI();
}

// UI Updates
function showMessage(msg){ document.getElementById('info').innerHTML=`<div>${msg}</div>`+document.getElementById('info').innerHTML; }
function updateUI(){
  document.getElementById('stats').innerHTML=`<strong>Score</strong> Home ${homeScore} - ${awayScore} Away<br>Week ${season.week}`;
  displayBracket(); displayRoster();
}
function displayBracket(){
  let html='<h3>Play Log</h3><ol>'; season.bracket.slice(-12).forEach(x=>{ html+=`<li>W${x.week||''} ${x.play}: ${x.result} ${x.pts? '('+x.pts+')':''}</li>` }); html+='</ol>';
  document.getElementById('bracket').innerHTML=html;
}
function displayRoster(){
  let html='<h3>Roster</h3><div style="display:flex;justify-content:center;gap:12px">';
  homeTeam.forEach(p=>{ html+=`<div style="text-align:center">${p.id}<br>PTS:${p.points}</div>` });
  html+='</div>'; document.getElementById('stats').innerHTML+=html;
}

// === Input & Movement ===
let keys={};
document.addEventListener('keydown',e=>keys[e.key]=true);
document.addEventListener('keyup',e=>keys[e.key]=false);

function handleMovement(){
  if(disableControl) return;
  const me=homeTeam.find(p=>p.control); if(!me) return;
  const speed=(keys['Shift']?1.8:3.2);
  if(keys['ArrowLeft']){ me.x-=speed; me.action='run'; }
  if(keys['ArrowRight']){ me.x+=speed; me.action='run'; }
  if(keys['ArrowUp']){ me.y-=speed; me.action='run'; }
  if(keys['ArrowDown']){ me.y+=speed; me.action='run'; }
  if(!keys['ArrowLeft']&&!keys['ArrowRight']&&!keys['ArrowUp']&&!keys['ArrowDown']){ if(me.action==='run') me.action='idle'; }
  me.x=Math.max(30,Math.min(court.w-30,me.x));
  me.y=Math.max(30,Math.min(court.h-30,me.y));

  if(keys[' '] && me.hasBall){ me.action='shoot'; const shot=evaluatePlay({id:'quick'}); me.shots++; if(shot.made){ me.points+=shot.pts; me.made++; homeScore+=shot.pts; } me.hasBall=false; possession='away'; setTimeout(opponentPossession,500); }
  if(keys['p'] && me.hasBall){ const teammate=homeTeam.filter(h=>h!==me)[rand(0,homeTeam.length-2)]; me.hasBall=false; teammate.hasBall=true; teammate.action='dribble'; me.action='idle'; }
}

// === Draw Court ===
function drawHoop(x,y){
  ctx.fillStyle='#ff4444'; ctx.fillRect(x-20,y,40,6);
}
function drawCourt(){
  ctx.fillStyle='#8aa65b'; ctx.fillRect(0,0,court.w,court.h);
  ctx.strokeStyle='#fff'; ctx.lineWidth=3; ctx.strokeRect(10,10,court.w-20,court.h-20);

  // center circle
  ctx.beginPath(); ctx.arc(court.w/2,court.h/2,36,0,Math.PI*2); ctx.stroke();

  // Paints
  ctx.fillStyle='#d4a017';
  ctx.fillRect(court.w/2-60,10,120,120); // top paint
  ctx.fillRect(court.w/2-60,court.h-130,120,120); // bottom paint

  // Hoops
  drawHoop(court.w/2,30); // top
  drawHoop(court.w/2,court.h-26); // bottom

  // Backboards
  ctx.fillStyle='#ddd';
  ctx.fillRect(court.w/2-30,24,60,4); // top
  ctx.fillRect(court.w/2-30,court.h-32,60,4); // bottom

  // 3pt arcs
  ctx.beginPath();
  ctx.arc(court.w/2,130,140,Math.PI,0); ctx.stroke();
  ctx.beginPath();
  ctx.arc(court.w/2,court.h-130,140,0,Math.PI); ctx.stroke();
}

// === Draw Loop ===
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawCourt();
  [...homeTeam,...awayTeam].forEach(p=>p.draw());
  if(ball.moving){ ctx.fillStyle='#ff0'; ctx.fillRect(ball.x,ball.y,6,6); }
}

// === Main Loop ===
function loop(){ handleMovement(); draw(); requestAnimationFrame(loop); }
loop();

// === Controls ===
document.getElementById('enterPlayMode').onclick=()=>{ showPlayOverlay(); };
document.getElementById('cancelPlay').onclick=()=>{ hidePlayOverlay(); };
document.getElementById('callPlay').onclick=()=>{ if(!selectedPlay)return alert('Select a play first'); hidePlayOverlay(); };
document.getElementById('saveBtn').onclick=saveGame;
document.getElementById('loadBtn').onclick=loadGame;

// === Save/Load ===
function serializePlayers(arr){ return arr.map(p=>({id:p.id,x:p.x,y:p.y,team:p.team,hasBall:p.hasBall,action:p.action,frame:p.frame,points:p.points,shots:p.shots,made:p.made,assists:p.assists})); }
function deserializePlayers(data){ return data.map(d=>{ const p=new Player(d.id,d.x,d.y,d.team); p.hasBall=d.hasBall; p.action=d.action; p.frame=d.frame; p.points=d.points; p.shots=d.shots; p.made=d.made; p.assists=d.assists; return p; }); }
function saveGame(){ const state={season,homeTeam:serializePlayers(homeTeam),awayTeam:serializePlayers(awayTeam),ball,homeScore,awayScore}; localStorage.setItem('retroHoopsSave',JSON.stringify(state)); alert('Saved'); }
function loadGame(){ const data=localStorage.getItem('retroHoopsSave'); if(!data)return alert('No save found'); const s=JSON.parse(data); season=s.season; homeTeam=deserializePlayers(s.homeTeam); awayTeam=deserializePlayers(s.awayTeam); ball=s.ball; homeScore=s.homeScore; awayScore=s.awayScore; alert('Loaded'); updateUI(); }

showMessage('NBA Jam–style sprites enabled. Full court, 2 hoops, correct lines.');
updateUI();
</script>
</body>
</html>
